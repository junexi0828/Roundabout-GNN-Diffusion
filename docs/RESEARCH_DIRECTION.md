# 연구 방향: Diffusion 모델 통합

## 🎯 생성형 AI의 역할 (핵심)

### 우리 프로젝트에서 생성형 AI = Diffusion 모델

```
📍 현재 위치 (관측)
    ↓
🧠 GNN (상호작용 분석)
    ↓
🎨 Diffusion (생성형 AI) ← 여기!
    ↓
📊 20개 가능한 미래 경로 생성
```

**역할**:
- ❌ 새로운 이미지/텍스트 생성 (일반 생성형 AI)
- ✅ **다양한 미래 궤적 생성** (우리 프로젝트)

---

## 🔄 전체 흐름 (핵심)

### 3단계 파이프라인

```
1️⃣ 관측 & 분석
┌─────────────────────────┐
│ 입력: 과거 3초 궤적      │
│ + 씬 그래프 (상호작용)   │
└──────────┬──────────────┘
           │
2️⃣ 상호작용 모델링 (GNN)
┌──────────▼──────────────┐
│ HeteroGAT               │
│ - 차량 ↔ 보행자 상호작용 │
│ - 자전거 ↔ 차량 양보     │
│ - 충돌 회피 패턴         │
└──────────┬──────────────┘
           │
3️⃣ 미래 생성 (Diffusion) ← 생성형 AI
┌──────────▼──────────────┐
│ LED Diffusion           │
│ - 노이즈 → 궤적 변환     │
│ - 20개 가능 경로 생성    │
│ - 확률 분포 출력         │
└──────────┬──────────────┘
           │
4️⃣ 안전 검증 (Plan B)
┌──────────▼──────────────┐
│ 안전 필터링              │
│ - TTC < 1.5초 제거       │
│ - 충돌 경로 제거         │
└──────────┬──────────────┘
           │
           ▼
📍 출력: 안전한 다중 미래 경로
```

---

## 💡 생성형 AI의 핵심 역할

### "하나의 미래" → "20개의 가능한 미래"

**기존 (GNN만)**:
```
관측 → GNN → 단일 예측
"차량 A는 5초 후 여기에 있을 것이다"
```

**생성형 AI 추가 (GNN + Diffusion)**:
```
관측 → GNN → Diffusion → 20개 예측
"차량 A는 5초 후 이 20가지 경로 중 하나를 선택할 것이다"
- 경로 1: 직진 (확률 40%)
- 경로 2: 양보 후 진입 (확률 30%)
- 경로 3: 급정거 (확률 20%)
- ...
```

---

## 🎨 생성형 AI의 작동 원리 (간단히)

### Diffusion = 노이즈에서 궤적 만들기

```
Step 1: 랜덤 노이즈
🌫️🌫️🌫️ (완전 무작위)

Step 2: 조금씩 정리 (GNN 정보 활용)
🌫️🌫️ → 대략적인 방향

Step 3: 더 정리
🌫️ → 구체적인 경로

Step 4: 완성
📍→📍→📍 (명확한 궤적)
```

**핵심**: GNN이 "어떤 방향으로 정리할지" 가이드

---

## 📊 최종 모델 선택: LED (Leapfrog Diffusion)

### 왜 LED?

1. ✅ **검증됨** (CVPR 2023 - 최신)
2. ✅ **코드 공개** (GitHub)
3. ✅ **매우 빠름** (20-30배, 실시간 가능)
4. ✅ **더 정확함** (MID보다 15-24% 개선)
5. ✅ **확장 쉬움** (이기종 환경)

### MID는?

- ✅ 검증됨 (CVPR 2022)
- ✅ 이론적 근거 강함 ("Motion Indeterminacy")
- ⚠️ LED보다 느림
- 💡 **비교 연구로 활용 가능**

---

## 🎯 요약 (한 문장)

> **GNN으로 상호작용을 분석하고, Diffusion(생성형 AI)으로 다양한 미래 경로를 생성하여, 안전한 예측을 제공한다.**

### 생성형 AI의 역할

- 단일 미래 → **다양한 가능성 생성**
- 불확실성 → **확률 분포로 표현**
- 위험 → **안전한 경로 선택**

---

## 🎯 현재 연구의 방향

### 1. 현재 프로젝트의 접근법

**GNN 기반 확정적/확률적 예측**:

- A3TGCN: 시공간 그래프 신경망
- Heterogeneous GNN: 이기종 에이전트 처리
- 출력: 단일 궤적 또는 가우시안 분포

**제한사항**:

- 다중 모달리티 표현이 제한적
- 다양한 미래 시나리오 생성 어려움

### 2. MID (Motion Indeterminacy Diffusion)의 접근법

**Diffusion 기반 생성형 예측**:

- 명시적 다중 모달리티 모델링
- 확률적 궤적 생성 (다양한 미래 시나리오)
- DDIM으로 빠른 샘플링 (2 스텝, 50x 가속)

**강점**:

- 강력한 다중 모달리티 생성 능력
- 확률적 예측으로 불확실성 정량화

## 🔬 연구 방향: 하이브리드 접근

### 방향 1: GNN-Diffusion 하이브리드 (권장) ⭐

```
┌─────────────────────────────────────────┐
│  입력: 관측 궤적 + 씬 그래프            │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  GNN Encoder (상호작용 모델링)          │
│  - HeteroGAT: 이기종 에이전트 처리       │
│  - 씬 그래프 특징 추출                   │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  Diffusion Decoder (다중 모달리티 생성)  │
│  - 조건부 Diffusion                      │
│  - 다중 궤적 샘플링                      │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  출력: 다중 궤적 샘플 (20개)             │
│  - 다양한 미래 시나리오                  │
│  - 확률 분포                            │
└─────────────────────────────────────────┘
```

**장점**:

- ✅ GNN의 상호작용 모델링 + Diffusion의 다중 모달리티
- ✅ 이기종 에이전트 처리 가능
- ✅ 씬 그래프 정보 활용
- ✅ 확률적 예측으로 다양한 미래 시나리오

### 방향 2: MID 기반 이기종 확장

```
MID 아키텍처
  ↓
이기종 에이전트 타입 인코딩 추가
  ↓
씬 그래프 조건부 Diffusion
  ↓
안전 가이드 샘플링 (Plan B)
  ↓
출력: 안전한 다중 궤적
```

## 📊 연구 기여도 분석

### 현재 프로젝트의 고유 강점

1. **이기종 교통 환경**

   - 차량, 보행자, 자전거, 스케이터 등 6종 에이전트
   - 타입별 다른 물리적 제약 및 행동 패턴

2. **회전교차로 특화**

   - 비신호 회전교차로 환경
   - 복잡한 상호작용 (양보, 충돌 회피 등)

3. **씬 그래프 기반 모델링**

   - 공간적 관계 (Spatial Edges)
   - 의미론적 관계 (Semantic Edges: yield, overtake 등)

4. **안전 검증 레이어 (Plan B)**
   - TTC, PET, DRAC 기반 위험도 평가
   - 안전한 예측 필터링

### MID 통합 시 추가 기여

1. **확률적 다중 모달리티 예측**

   - 다양한 미래 시나리오 생성
   - 불확실성 정량화

2. **생성형 AI 접목**

   - Diffusion 모델의 생성 능력
   - 다양한 가능성 탐색

3. **이기종 환경 확장**
   - MID를 이기종 에이전트로 확장
   - 타입별 조건부 Diffusion

## 🚀 구체적 통합 전략

### 전략 A: GNN-Diffusion 하이브리드 (1단계)

**구현**:

1. GNN Encoder: 씬 그래프 → 상호작용 특징
2. Diffusion Decoder: 특징 → 다중 궤적 샘플
3. 조건부 Diffusion: GNN 특징을 조건으로 사용

**코드 위치**: `src/models/diffusion_model.py`

### 전략 B: 안전 가이드 샘플링 (2단계)

**구현**:

1. Diffusion으로 다중 궤적 생성 (20개)
2. Plan B 안전 지표로 각 샘플 평가
3. 안전한 샘플만 선택 또는 재샘플링

**코드 위치**: `src/integration/hybrid_safety_layer.py` 확장

### 전략 C: 이기종 조건부 Diffusion (3단계)

**구현**:

1. 에이전트 타입별 인코딩
2. 타입별 조건부 Diffusion
3. 타입 간 상호작용 고려

## 📈 연구 질문 및 가설

### 연구 질문 1

**Q**: 이기종 환경에서 Diffusion이 어떻게 다중 모달리티를 생성하는가?

**가설**:

- 차량: 차선 준수, 물리적 제약이 강함 → 제한된 모달리티
- 보행자: 자유로운 이동 → 넓은 모달리티
- 자전거: 중간 특성 → 중간 모달리티

### 연구 질문 2

**Q**: 씬 그래프 조건부 Diffusion의 효과는?

**가설**:

- 상호작용 정보가 Diffusion 과정을 가이드
- 위험한 궤적의 확률 감소
- 안전한 궤적의 확률 증가

### 연구 질문 3

**Q**: 안전 지표 기반 샘플링의 효과는?

**가설**:

- Plan B 안전 지표로 위험한 궤적 필터링
- 안전한 다중 궤적 생성
- 실제 안전성 향상

## 🎯 최종 연구 목표

**주제**: "이기종 교통 환경에서 씬 그래프 조건부 Diffusion 기반 확률적 다중 모달리티 궤적 예측"

**기여도**:

1. ✅ 이기종 환경에서의 Diffusion 모델 확장
2. ✅ 씬 그래프 조건부 Diffusion 제안
3. ✅ 안전 가이드 샘플링 방법론
4. ✅ 회전교차로 특화 상호작용 모델링

**기대 결과**:

- 다양한 미래 시나리오 생성
- 불확실성 정량화
- 안전한 예측 보장

## 📚 참고 자료

- **MID 논문**: [CVPR 2022] "Stochastic Trajectory Prediction via Motion Indeterminacy Diffusion"
- **MID 코드**: https://github.com/Gutianpei/MID.git
- **DDIM**: "Denoising Diffusion Implicit Models" (ICLR 2021) - 빠른 샘플링

## 🔄 다음 단계

1. **Diffusion 모델 구현** (완료: `src/models/diffusion_model.py`)
2. **GNN-Diffusion 통합 테스트**
3. **안전 가이드 샘플링 구현**
4. **실험 및 평가**
